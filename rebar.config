{erl_opts, [
    debug_info,
    warn_export_vars,
    warn_shadow_vars,
    warn_obsolete_guard,
    {i, "include"}
]}.

{deps, [
    {cowboy, "2.10.0"},
    {jsx, "3.1.0"},
    {prometheus, "4.10.0"},
    {prometheus_cowboy, "0.1.8"}
]}.

%% NIF compilation settings for SYN scanner
{port_specs, [
    {"priv/syn_scanner.so", ["c_src/syn_scanner.c"]}
]}.

{port_env, [
    {"darwin", "CFLAGS", "$CFLAGS -O3 -Wall -fPIC"},
    {"darwin", "LDFLAGS", "$LDFLAGS -flat_namespace -undefined suppress -lpcap"},
    {"linux", "CFLAGS", "$CFLAGS -O3 -Wall -fPIC"},
    {"linux", "LDFLAGS", "$LDFLAGS"}
]}.

{pre_hooks, [
    {"(linux|darwin)", compile, "mkdir -p priv"}
]}.

{shell, [
    {apps, [massping]}
]}.

{relx, [
    {release, {massping, "1.0.0"}, [
        massping,
        sasl
    ]},
    {mode, prod},
    {include_erts, true},
    {extended_start_script, true}
]}.

{profiles, [
    {prod, [
        {erl_opts, [no_debug_info, warnings_as_errors]}
    ]},
    {test, [
        {erl_opts, [debug_info, export_all]},
        {deps, [
            {proper, "1.4.0"}
        ]}
    ]}
]}.

{plugins, [
    rebar3_proper,
    pc  %% Port compiler for NIF
]}.

{escript_main_app, massping}.
{escript_name, massping}.
{escript_emu_args, "%%! +sbtu +A1\n"}.
{escript_incl_priv, [{massping, true}]}.

{project_plugins, [rebar3_hex]}.

%% Provider hooks to compile NIF
{provider_hooks, [
    {pre, [
        {compile, {pc, compile}},
        {clean, {pc, clean}}
    ]}
]}.
